<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Price Tracker ‚Äî Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0b1220;
      --accent-teal:#06b6a4;
      --accent-indigo:#4f46e5;
      --flat-shadow:0 4px 16px rgba(0,0,0,0.05);
      --radius:10px;
      --divider:rgba(0,0,0,0.05);
      --ui:160ms cubic-bezier(.2,.9,.25,1);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui;
      background:var(--bg);
      color:var(--text);
      font-size:14px;
    }
    header{
      position:fixed;top:0;left:0;right:0;height:56px;
      background:white;backdrop-filter:blur(6px);
      display:flex;align-items:center;justify-content:space-between;
      padding:0 16px;z-index:1000;
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    header h1{margin:0;font-size:1rem;color:var(--accent-indigo);}
    .btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:.9rem;transition:background var(--ui);}
    .btn-primary{background:linear-gradient(90deg,var(--accent-teal),#10b981);color:white;}
    .btn-outline{background:white;border:1px solid #dce3eb;color:var(--accent-indigo);}
    .btn-danger{background:#ef4444;color:white;}
    main{padding-top:120px;max-width:1100px;margin:0 auto;}
    .add-bar{
      position:fixed;top:56px;left:0;right:0;background:white;
      box-shadow:0 2px 6px rgba(0,0,0,0.04);
      padding:8px 16px;display:flex;gap:8px;align-items:center;z-index:900;
    }
    .add-bar input[type=text]{flex:1;padding:6px 8px;border-radius:8px;border:1px solid #e0e7ef;font-size:.9rem;}
    .product-card{
      background:var(--card);
      box-shadow:var(--flat-shadow);
      border-radius:var(--radius);
      margin:8px 12px;
      padding:10px;
      display:flex;gap:12px;
      align-items:flex-start;
    }
    .product-img{
      width:120px;height:120px;object-fit:cover;
      border-radius:var(--radius);
      background:#f0f2f5;
      flex-shrink:0;
    }
    .product-info{flex:1;min-width:0;}
    .product-header{display:flex;align-items:center;justify-content:space-between;gap:8px;}
    .product-header h2{font-size:1rem;margin:0;color:var(--accent-indigo);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
    .price{font-weight:700;color:var(--accent-teal);}
    .muted{color:var(--muted);font-size:.85rem;}
    .links-container,.chart-container{margin-top:8px;display:none;}
    canvas{max-width:100%;height:180px;}
    .pos-input{width:72px;padding:6px;border-radius:6px;border:1px solid #e6eef3;font-size:.9rem;}
    .compact-btn{padding:6px 8px;border-radius:6px;border:1px solid rgba(12,18,30,0.04);background:white;cursor:pointer;font-weight:700;}
    #log-container{position:fixed;bottom:0;left:0;right:0;background:white;padding:10px;max-height:200px;overflow-y:auto;border-top:1px solid var(--divider);display:none;}
  </style>
</head>
<body>
  <header>
    <h1>üí∞ Price Tracker</h1>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button id="updateAllBtn" class="btn btn-primary">Update All</button>
      <button id="settingsBtn" class="btn btn-outline">Settings</button>
      <button id="logsBtn" class="btn btn-outline">Logs</button>
    </div>
  </header>

  <div class="add-bar">
    <input id="nameInput" type="text" placeholder="Product name (optional, auto-fetches if empty)" />
    <input id="urlInput" type="text" placeholder="URL (comma-separated)" />
    <button id="addBtn" class="btn btn-primary">Add</button>
  </div>

  <main id="productList"></main>

  <div id="log-container">
    <div id="logs"></div>
  </div>

  <script>
    const $ = (s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const list=$('#productList');
    let products=[];

    function log(msg) {
      const logs = $('#logs');
      logs.innerHTML += `<div class="muted" style="font-size:0.85rem;">[${new Date().toLocaleString()}] ${escapeHtml(msg)}</div>`;
      logs.scrollTop = logs.scrollHeight;
    }

    async function loadProducts(){
      try{
        const res=await fetch('/api/items');
        products=await res.json();
        log('Loaded products');
      }catch(e){ products=[]; log('Failed to load products: ' + e.message); }
      renderProducts();
    }

    function escapeHtml(s){ return (s||'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function truncate(s,n=80){ return s && s.length>n ? s.slice(0,n)+'‚Ä¶' : s; }
    function formatPrice(v){ return v==null ? '‚Äî' : '$'+Number(v).toFixed(2); }

    function renderProducts(){
      list.innerHTML='';
      for(const p of products){
        const card=document.createElement('div');
        card.className='product-card';
        card.dataset.id=p.id;

        const img=document.createElement('img');
        img.className='product-img';
        img.src=p.imageUrl||'';
        img.style.display=(p.imageUrl&&p.imageUrl.trim())?'block':'none';

        const info=document.createElement('div');
        info.className='product-info';

        const header=document.createElement('div');
        header.className='product-header';

        const title=document.createElement('h2');
        title.textContent=p.name||'Unnamed';
        title.contentEditable = true;

        const meta=document.createElement('div');
        meta.className='muted';
        meta.textContent=p.lastUpdated?new Date(p.lastUpdated).toLocaleString():'';

        header.append(title, meta);

        const priceRow=document.createElement('div');
        priceRow.style.display='flex';
        priceRow.style.flexWrap='wrap';
        priceRow.style.justifyContent='space-between';
        priceRow.style.alignItems='flex-start';
        priceRow.style.gap='12px';
        priceRow.style.marginTop='8px';

        const bestBox=document.createElement('div');
        bestBox.style.flex='1 1 200px';
        bestBox.innerHTML=`<div class="muted">Best link</div><div style="margin-top:6px">${p.bestUrl ? '<a href="'+escapeHtml(p.bestUrl)+'" target="_blank">'+escapeHtml(truncate(p.bestUrl,60))+'</a>' : '<span class="muted">no links</span>'}</div>`;

// --- Current Low box ---
const currLowBox = document.createElement('div');
currLowBox.style.textAlign = 'right';

let currColor = 'var(--accent-teal)'; // default (good / equal)
if (p.currentPrice != null && p.minPrice != null) {
  if (p.currentPrice > p.minPrice) currColor = '#ef4444'; // red if higher than historical low
}

currLowBox.innerHTML = `
  <div class="muted">Current Low</div>
  <div class="price" style="margin-top:6px; color:${currColor};">
    ${formatPrice(p.currentPrice)}
  </div>`;

// --- Historical Low box ---
const histLowBox = document.createElement('div');
histLowBox.style.textAlign = 'right';
histLowBox.innerHTML = `
  <div class="muted">Hist Low</div>
  <div class="price" style="margin-top:6px; color:var(--accent-indigo);">
    ${formatPrice(p.minPrice)}
  </div>`;

// --- Historical High box ---
const histHighBox = document.createElement('div');
histHighBox.style.textAlign = 'right';
histHighBox.innerHTML = `
  <div class="muted">Hist High</div>
  <div class="price" style="margin-top:6px; color:var(--accent-indigo);">
    ${formatPrice(p.maxPrice)}
  </div>`;

        priceRow.append(bestBox, currLowBox, histLowBox, histHighBox);

        const actions=document.createElement('div');
        actions.className='actions';

actions.innerHTML = `
  <input class="pos-input" type="number"
    value="${typeof p.position === 'number' ? p.position : 0}"
    style="display:none;" />
  <button class="compact-btn update-btn">Update</button>
  <button class="compact-btn save-btn">Save</button>
  <button class="compact-btn chart-btn">Show Chart</button>
  <button class="compact-btn links-btn">Show Links</button>
  <button class="compact-btn delete-btn"
    style="background:#ef4444;color:white;border:none;">üóëÔ∏è Delete</button>
  <button class="compact-btn up-btn">‚Üë</button>
  <button class="compact-btn down-btn">‚Üì</button>
  <button class="compact-btn move-top-btn">‚§¥Ô∏è Move to Top</button>
`;



        const linksContainer=document.createElement('div');
        linksContainer.className='links-container';
        linksContainer.style.display='none';
        const linksInner = document.createElement('div');
        (p.sites||[]).forEach(s=>{
          const div=document.createElement('div');
          div.style.marginBottom='8px';
          div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;"><div style="min-width:0"><a href="${escapeHtml(s.url)}" target="_blank">${escapeHtml(truncate(s.url,80))}</a><div class="muted">${formatPrice(s.currentPrice)}</div></div><div><button class="compact-btn delete-link-btn" data-siteid="${s.id}">Delete</button></div></div>`;
          linksInner.append(div);
        });
        const addLinkRow=document.createElement('div');
        addLinkRow.style.display='flex';
        addLinkRow.style.gap='8px';
        addLinkRow.style.marginTop='8px';
        addLinkRow.innerHTML=`<input type="text" class="add-link-input" placeholder="Add new URL" style="flex:1;padding:6px;border-radius:6px;border:1px solid #e6eef3;"><button class="compact-btn add-link-btn">Add Link</button>`;

        const imageRow=document.createElement('div');
        imageRow.style.marginTop='8px';
        imageRow.style.display='flex';
        imageRow.style.gap='8px';
        imageRow.innerHTML=`<input type="url" class="image-url-input" placeholder="Image URL (png/jpg/webp)" value="${escapeHtml(p.imageUrl||'')}" style="flex:1;padding:6px;border-radius:6px;border:1px solid #e6eef3;"><button class="compact-btn save-image-btn">Save Image</button>`;
        linksContainer.append(linksInner, addLinkRow, imageRow);

        const chartContainer=document.createElement('div');
        chartContainer.className='chart-container';
        chartContainer.style.display='none';
        chartContainer.innerHTML=`<canvas></canvas>`;

        info.append(header, priceRow, actions, linksContainer, chartContainer);
        card.append(img, info);
        list.append(card);
      }
    }

    document.addEventListener('click', async (ev) => {
      const btn = ev.target;
      const card = btn.closest('.product-card');
      if (!card) return;
      const id = card.dataset.id;
      const product = products.find(x => x.id === id);

      if (btn.classList.contains('update-btn')) {
        btn.disabled = true;
        try {
          await fetch(`/api/items/${id}/update`, { method: 'POST' });
          log(`Updated prices for product ${product.name || id}`);
          await loadProducts();
        } catch (e) {
          log(`Failed to update product ${product.name || id}: ${e.message}`);
        }
        btn.disabled = false;
      }

      if (btn.classList.contains('save-btn')) {
        const newName = card.querySelector('h2').textContent.trim();
        const imgField = card.querySelector('.image-url-input');
        const body = { name: newName, imageUrl: imgField ? imgField.value.trim() : product.imageUrl };
        try {
          await fetch(`/api/items/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
          log(`Saved changes for product ${newName || id} (name updated to ${newName})`);
          await loadProducts();
        } catch (e) {
          log(`Failed to save product ${newName || id}: ${e.message}`);
        }
      }

      if (btn.classList.contains('chart-btn')) {
        const c = card.querySelector('.chart-container');
        if (c.style.display === 'none') { c.style.display = 'block'; renderChart(card, product); btn.textContent='Hide Chart'; } else { c.style.display = 'none'; btn.textContent='Show Chart'; }
      }

      if (btn.classList.contains('links-btn')) {
        const c = card.querySelector('.links-container');
        if (c.style.display === 'none') { c.style.display = 'block'; btn.textContent='Hide Links'; const img = card.querySelector('.product-img'); img.style.display = (product.imageUrl) ? 'block' : 'none'; } else { c.style.display = 'none'; btn.textContent='Show Links'; const img = card.querySelector('.product-img'); img.style.display = 'none'; }
      }

      if (btn.classList.contains('delete-btn')) {
        if (!confirm('Delete this product?')) return;
        try {
          const res = await fetch(`/api/items/${id}`, { method: 'DELETE' });
          if (res.ok) { 
            card.remove(); 
            log(`Deleted product ${product.name || id}`); 
          }
        } catch (e) {
          log(`Failed to delete product ${product.name || id}: ${e.message}`);
        }
      }

      if (btn.classList.contains('delete-link-btn')) {
        const siteId = btn.getAttribute('data-siteid');
        if (!confirm('Delete link?')) return;
        try {
          await fetch(`/api/items/${id}/sites/${siteId}`, { method: 'DELETE' });
          log(`Deleted link from product ${product.name || id}`);
          await loadProducts();
        } catch (e) {
          log(`Failed to delete link: ${e.message}`);
        }
      }

      if (btn.classList.contains('add-link-btn')) {
        const input = card.querySelector('.add-link-input');
        const newUrl = input.value.trim();
        if (!newUrl) return alert('Enter a URL');
        try {
          await fetch(`/api/items/${id}/sites`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url: newUrl }) });
          input.value = '';
          log(`Added new link to product ${product.name || id}`);
          await loadProducts();
        } catch (e) {
          log(`Failed to add link: ${e.message}`);
        }
      }

if (btn.classList.contains('up-btn') || btn.classList.contains('down-btn') || btn.classList.contains('move-top-btn')) {
  let direction;
  if (btn.classList.contains('up-btn')) direction = 'up';
  else if (btn.classList.contains('down-btn')) direction = 'down';
  else direction = 'top';

        try {
          await fetch('/api/items/reorder', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ id, direction }) });
          log(`Reordered product ${product.name || id} ${direction}`);
          await loadProducts();
        } catch (e) {
          log(`Failed to reorder: ${e.message}`);
        }
      }

      if (btn.classList.contains('save-image-btn')) {
        const val = card.querySelector('.image-url-input').value.trim() || null;
        try {
          await fetch(`/api/items/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ imageUrl: val }) });
          log(`Saved image for product ${product.name || id}`);
          await loadProducts();
        } catch (e) {
          log(`Failed to save image: ${e.message}`);
        }
      }
    });

    async function renderChart(card, product) {
      const canvas = card.querySelector('canvas');
      const ctx = canvas.getContext('2d');
      const labels = (product.historyDates || []).map(d => new Date(d).toLocaleDateString());
// Define a palette of distinct colors for each site
const COLORS = [
  '#4CAF50', '#2196F3', '#FF9800', '#E91E63', '#9C27B0',
  '#00BCD4', '#FFC107', '#F44336', '#3F51B5', '#8BC34A',
];

let datasets = (product.sites || []).map((site, i) => {
  const offset = (product.historyDates || []).length - (site.history || []).length;
  return {
    label: (new URL(site.url).hostname.replace(/^www\./,'')),
    fullUrl: site.url,
    data: (product.historyDates || []).map((_, i2) => {
      const siteIndex = i2 - offset;
      return siteIndex >= 0 && siteIndex < (site.history || []).length ? site.history[siteIndex] : null;
    }),
    borderColor: COLORS[i % COLORS.length],
    backgroundColor: COLORS[i % COLORS.length] + '33',
    tension: 0.25,
    spanGaps: true,
    pointRadius: 3,
  };
});

      if (!(labels.length && datasets.length)) return;

      const overallMin = product.minPrice;
      const overallMax = product.maxPrice;

      if (overallMin != null) {
        datasets.push({
          label: 'Historical Low',
          data: labels.map(() => overallMin),
          borderColor: '#22c55e',
          borderDash: [5, 5],
          tension: 0,
          pointRadius: 0,
        });
      }

      if (overallMax != null) {
        datasets.push({
          label: 'Historical High',
          data: labels.map(() => overallMax),
          borderColor: '#ef4444',
          borderDash: [5, 5],
          tension: 0,
          pointRadius: 0,
        });
      }

      if (!window._charts) window._charts = {};
      if (window._charts[product.id]) { try { window._charts[product.id].destroy(); } catch(e){} }
      window._charts[product.id] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins: {
            tooltip: {
              callbacks: {
                title: items => items && items.length ? items[0].label : '',
                label: ctx => {
                  const ds = ctx.dataset || {};
                  const y = ctx.raw ?? ctx.parsed?.y ?? null;
                  const host = ds.label || '';
                  const full = ds.fullUrl || '';
                  const short = full.length > 80 ? full.slice(0,80)+'‚Ä¶' : full;
                  return [host, short, `Price: $${Number(y).toFixed(2)}`];
                }
              }
            }
          },
          scales: { x: { grid: { color: 'rgba(12,18,30,0.03)' } }, y: { grid: { color: 'rgba(12,18,30,0.03)' } } }
        }
      });
    }

    document.getElementById('addBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('nameInput').value.trim();
      const urls = document.getElementById('urlInput').value.split(',').map(u=>u.trim()).filter(Boolean);
      if (!urls.length) return alert('Add at least one URL');
      try {
        await fetch('/api/items', { method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name, urls }) });
        document.getElementById('nameInput').value=''; document.getElementById('urlInput').value='';
        log(`Added new product${name ? ': ' + name : ' (title auto-fetched)'} `);
        await loadProducts();
      } catch (e) {
        log(`Failed to add product: ${e.message}`);
      }
    });

const updateAllBtn = document.getElementById('updateAllBtn');

updateAllBtn.addEventListener('click', async ()=>{
  updateAllBtn.disabled = true;
  const originalText = updateAllBtn.textContent;
  updateAllBtn.textContent = "Updating All...";
  updateAllBtn.style.opacity = 0.6;
  updateAllBtn.style.cursor = "not-allowed";

  try {
    await fetch('/api/items/updateAll', { method:'POST' });
    log('Updated all products');
    await loadProducts();
  } catch (e) {
    log(`Failed to update all: ${e.message}`);
  } finally {
    updateAllBtn.disabled = false;
    updateAllBtn.textContent = originalText;
    updateAllBtn.style.opacity = 1;
    updateAllBtn.style.cursor = "pointer";
  }
});


    document.getElementById('settingsBtn').addEventListener('click', ()=> window.location.href='./settings.html');

    document.getElementById('logsBtn').addEventListener('click', ()=>{
      const cont = $('#log-container');
      cont.style.display = cont.style.display === 'none' ? 'block' : 'none';
    });

    // initial load
    loadProducts();
  </script>
</body>
</html>